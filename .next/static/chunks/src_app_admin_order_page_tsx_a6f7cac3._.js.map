{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file://D%3A/FPOLY/ky5/ASM_Next/Pure-Botanica/src/app/admin/order/page.tsx"],"sourcesContent":["\"use client\";\r\nimport { useState, useEffect } from \"react\";\r\nimport axios from \"axios\";\r\nimport toast from \"react-hot-toast\";\r\nimport \"./order.css\";\r\n\r\nexport default function OrderPage() {\r\n  interface Product {\r\n    name: string;\r\n    price: number;\r\n    discountPrice: number | null;\r\n    images?: string[]; // Trường hình ảnh\r\n  }\r\n\r\n  interface Order {\r\n    _id: string;\r\n    user: {\r\n      _id: string;\r\n      username: string;\r\n    };\r\n    createdAt: string;\r\n    status: string;\r\n    address: string;\r\n    items: { product: Product; quantity: number }[];\r\n  }\r\n\r\n  const [orders, setOrders] = useState<Order[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);\r\n  const [showPopup, setShowPopup] = useState<boolean>(false);\r\n\r\n  // Đối chiếu trạng thái tiếng Anh sang tiếng Việt\r\n  const statusMapping = {\r\n    pending: \"Chờ xử lý\",\r\n    shipped: \"Đang giao hàng\",\r\n    delivered: \"Đã giao hàng\",\r\n    cancelled: \"Đã hủy\"\r\n  };\r\n\r\n  // Đối chiếu ngược lại từ tiếng Việt sang tiếng Anh\r\n  const reverseStatusMapping = {\r\n    \"Chờ xử lý\": \"pending\",\r\n    \"Đang giao hàng\": \"shipped\",\r\n    \"Đã giao hàng\": \"delivered\",\r\n    \"Đã hủy\": \"cancelled\"\r\n  };\r\n\r\n  // Fetch orders from API\r\n  useEffect(() => {\r\n    const fetchOrders = async () => {\r\n      try {\r\n        const response = await axios.get<Order[]>(\"https://api-zeal.onrender.com/api/orders/all\");\r\n        setOrders(response.data);\r\n      } catch (error) {\r\n        console.error(\"Lỗi khi tải danh sách đơn hàng:\", error);\r\n        setError(\"Không thể tải danh sách đơn hàng\");\r\n      }\r\n    };\r\n    fetchOrders();\r\n  }, []);\r\n\r\n  // Format date\r\n  const formatDate = (dateString: string | number | Date) => {\r\n    const date = new Date(dateString);\r\n    return `${date.getDate().toString().padStart(2, \"0\")}-${(date.getMonth() + 1)\r\n      .toString()\r\n      .padStart(2, \"0\")}-${date.getFullYear()}`;\r\n  };\r\n\r\n  // Hiển thị trạng thái bằng tiếng Việt\r\n  const getVietnameseStatus = (status: string) => {\r\n    return statusMapping[status as keyof typeof statusMapping] || status;\r\n  };\r\n\r\n  // Update order status\r\n  const handleStatusChange = async (orderId: string, userId: string, newStatus: string, currentStatus: string) => {\r\n    // Kiểm tra nếu đơn hàng đã giao hàng thì không cho phép thay đổi\r\n    if (currentStatus === \"delivered\") {\r\n      toast.error(\"Không thể thay đổi trạng thái đơn hàng đã giao thành công\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Chuyển đổi trạng thái tiếng Việt sang tiếng Anh để gửi lên API\r\n      const englishStatus = reverseStatusMapping[newStatus as keyof typeof reverseStatusMapping] || newStatus;\r\n      \r\n      await axios.put(\r\n        `https://api-zeal.onrender.com/api/orders/status/${orderId}?userId=${userId}`,\r\n        { status: englishStatus }\r\n      );\r\n      \r\n      toast.success(\"Cập nhật trạng thái thành công\");\r\n      \r\n      setOrders((prevOrders) =>\r\n        prevOrders.map((order) =>\r\n          order._id === orderId ? { ...order, status: englishStatus } : order\r\n        )\r\n      );\r\n    } catch (error) {\r\n      console.error(\"Lỗi cập nhật trạng thái:\", error);\r\n      toast.error(\"Không thể cập nhật trạng thái\");\r\n    }\r\n  };\r\n\r\n  // Handle click on an order to show the detail popup\r\n  const handleOrderClick = (order: Order, e: React.MouseEvent) => {\r\n    // Don't open popup if clicking on the status select element\r\n    if ((e.target as HTMLElement).tagName === 'SELECT') {\r\n      return;\r\n    }\r\n    setSelectedOrder(order);\r\n    setShowPopup(true);\r\n  };\r\n\r\n  // Close the popup\r\n  const closePopup = () => {\r\n    setShowPopup(false);\r\n  };\r\n\r\n  // Calculate product total\r\n  const calculateProductTotal = (product: Product, quantity: number) => {\r\n    const price = product.discountPrice || product.price;\r\n    return price * quantity;\r\n  };\r\n\r\n  // Calculate order total\r\n  const calculateOrderTotal = (items: { product: Product; quantity: number }[]) => {\r\n    return items.reduce((total, item) => total + calculateProductTotal(item.product, item.quantity), 0);\r\n  };\r\n\r\n  // Get product image URL from API\r\n  const getProductImage = (product: Product) => {\r\n    if (product.images && product.images.length > 0) {\r\n      return `https://api-zeal.onrender.com/images/${product.images[0]}`;\r\n    }\r\n    // Trả về hình ảnh placeholder nếu không có hình ảnh\r\n    return \"https://via.placeholder.com/60x60?text=No+Image\";\r\n  };\r\n\r\n  if (error) return <div className=\"error-message\">{error}</div>;\r\n  if (!orders.length) return <div className=\"loading-message\">Đang tải...</div>;\r\n\r\n  return (\r\n    <div className=\"order-container\">\r\n      <div className=\"title\">\r\n        <h1>Danh Sách Đơn Hàng</h1>\r\n      </div>\r\n      <div className=\"table-container\">\r\n        <table>\r\n          <thead>\r\n            <tr>\r\n              <th>ID</th>\r\n              <th>Tên</th>\r\n              <th>Địa Chỉ</th>\r\n              <th>Ngày</th>\r\n              <th>Trạng Thái</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            {orders.map((order, index) => (\r\n              <tr key={order._id} onClick={(e) => handleOrderClick(order, e)}>\r\n                <td>{index + 1}</td>\r\n                <td>{order.user.username}</td>\r\n                <td>{order.address || \"Chưa có địa chỉ\"}</td>\r\n                <td>{formatDate(order.createdAt)}</td>\r\n                <td>\r\n                  <select\r\n                    value={getVietnameseStatus(order.status)}\r\n                    onChange={(e) => \r\n                      handleStatusChange(order._id, order.user._id, e.target.value, order.status)\r\n                    }\r\n                    className={`status-select ${order.status}`}\r\n                    onClick={(e) => e.stopPropagation()}\r\n                    disabled={order.status === \"delivered\"} // Vô hiệu hóa nếu đã giao hàng\r\n                  >\r\n                    <option value=\"Chờ xử lý\">Chờ xử lý</option>\r\n                    <option value=\"Đang giao hàng\">Đang giao hàng</option>\r\n                    <option value=\"Đã giao hàng\">Đã giao hàng</option>\r\n                    <option value=\"Đã hủy\">Đã hủy</option>\r\n                  </select>\r\n                </td>\r\n              </tr>\r\n            ))}\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n\r\n      {showPopup && selectedOrder && (\r\n        <div className=\"popup-overlay\" onClick={closePopup}>\r\n          <div className=\"order-detail\" onClick={(e) => e.stopPropagation()}>\r\n            <button className=\"close-button\" onClick={closePopup}>&times;</button>\r\n            <h2>Chi Tiết Đơn Hàng</h2>\r\n            <p>\r\n              <strong>Khách hàng:</strong> {selectedOrder.user.username}\r\n            </p>\r\n            <p>\r\n              <strong>Địa chỉ:</strong> {selectedOrder.address || \"Chưa có địa chỉ\"}\r\n            </p>\r\n            <p>\r\n              <strong>Ngày:</strong> {formatDate(selectedOrder.createdAt)}\r\n            </p>\r\n            <p>\r\n              <strong>Trạng thái:</strong> {getVietnameseStatus(selectedOrder.status)}\r\n            </p>\r\n            <h3>Sản phẩm trong đơn hàng:</h3>\r\n            <ul>\r\n              {selectedOrder.items.map((item, idx) => (\r\n                <li key={idx}>\r\n                  <img \r\n                    src={getProductImage(item.product)} \r\n                    alt={item.product.name} \r\n                    className=\"product-image\" \r\n                    onError={(e) => {\r\n                      // Xử lý khi hình ảnh không tải được\r\n                      (e.target as HTMLImageElement).src = \"https://via.placeholder.com/60x60?text=Error\";\r\n                    }}\r\n                  />\r\n                  <div className=\"product-info\">\r\n                    <div className=\"product-name\">{item.product.name}</div>\r\n                    <div className=\"product-price\">\r\n                      {item.quantity} x {(item.product.discountPrice || item.product.price).toLocaleString()} VND = {\" \"}\r\n                      {calculateProductTotal(item.product, item.quantity).toLocaleString()} VND\r\n                    </div>\r\n                  </div>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n            <div className=\"total\">\r\n              Tổng tiền đơn hàng: {calculateOrderTotal(selectedOrder.items).toLocaleString()} VND\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":";;;;AACA;AACA;AACA;;;AAHA;;;;;AAMe,SAAS;;IAoBtB,MAAM,CAAC,QAAQ,UAAU,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAW,EAAE;IAChD,MAAM,CAAC,OAAO,SAAS,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAiB;IAClD,MAAM,CAAC,eAAe,iBAAiB,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAgB;IACjE,MAAM,CAAC,WAAW,aAAa,GAAG,CAAA,GAAA,6JAAA,CAAA,WAAQ,AAAD,EAAW;IAEpD,iDAAiD;IACjD,MAAM,gBAAgB;QACpB,SAAS;QACT,SAAS;QACT,WAAW;QACX,WAAW;IACb;IAEA,mDAAmD;IACnD,MAAM,uBAAuB;QAC3B,aAAa;QACb,kBAAkB;QAClB,gBAAgB;QAChB,UAAU;IACZ;IAEA,wBAAwB;IACxB,CAAA,GAAA,6JAAA,CAAA,YAAS,AAAD;+BAAE;YACR,MAAM;mDAAc;oBAClB,IAAI;wBACF,MAAM,WAAW,MAAM,wIAAA,CAAA,UAAK,CAAC,GAAG,CAAU;wBAC1C,UAAU,SAAS,IAAI;oBACzB,EAAE,OAAO,OAAO;wBACd,QAAQ,KAAK,CAAC,mCAAmC;wBACjD,SAAS;oBACX;gBACF;;YACA;QACF;8BAAG,EAAE;IAEL,cAAc;IACd,MAAM,aAAa,CAAC;QAClB,MAAM,OAAO,IAAI,KAAK;QACtB,OAAO,GAAG,KAAK,OAAO,GAAG,QAAQ,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,CAAC,KAAK,QAAQ,KAAK,CAAC,EACzE,QAAQ,GACR,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,KAAK,WAAW,IAAI;IAC7C;IAEA,sCAAsC;IACtC,MAAM,sBAAsB,CAAC;QAC3B,OAAO,aAAa,CAAC,OAAqC,IAAI;IAChE;IAEA,sBAAsB;IACtB,MAAM,qBAAqB,OAAO,SAAiB,QAAgB,WAAmB;QACpF,iEAAiE;QACjE,IAAI,kBAAkB,aAAa;YACjC,0JAAA,CAAA,UAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,IAAI;YACF,iEAAiE;YACjE,MAAM,gBAAgB,oBAAoB,CAAC,UAA+C,IAAI;YAE9F,MAAM,wIAAA,CAAA,UAAK,CAAC,GAAG,CACb,CAAC,gDAAgD,EAAE,QAAQ,QAAQ,EAAE,QAAQ,EAC7E;gBAAE,QAAQ;YAAc;YAG1B,0JAAA,CAAA,UAAK,CAAC,OAAO,CAAC;YAEd,UAAU,CAAC,aACT,WAAW,GAAG,CAAC,CAAC,QACd,MAAM,GAAG,KAAK,UAAU;wBAAE,GAAG,KAAK;wBAAE,QAAQ;oBAAc,IAAI;QAGpE,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,0JAAA,CAAA,UAAK,CAAC,KAAK,CAAC;QACd;IACF;IAEA,oDAAoD;IACpD,MAAM,mBAAmB,CAAC,OAAc;QACtC,4DAA4D;QAC5D,IAAI,AAAC,EAAE,MAAM,CAAiB,OAAO,KAAK,UAAU;YAClD;QACF;QACA,iBAAiB;QACjB,aAAa;IACf;IAEA,kBAAkB;IAClB,MAAM,aAAa;QACjB,aAAa;IACf;IAEA,0BAA0B;IAC1B,MAAM,wBAAwB,CAAC,SAAkB;QAC/C,MAAM,QAAQ,QAAQ,aAAa,IAAI,QAAQ,KAAK;QACpD,OAAO,QAAQ;IACjB;IAEA,wBAAwB;IACxB,MAAM,sBAAsB,CAAC;QAC3B,OAAO,MAAM,MAAM,CAAC,CAAC,OAAO,OAAS,QAAQ,sBAAsB,KAAK,OAAO,EAAE,KAAK,QAAQ,GAAG;IACnG;IAEA,iCAAiC;IACjC,MAAM,kBAAkB,CAAC;QACvB,IAAI,QAAQ,MAAM,IAAI,QAAQ,MAAM,CAAC,MAAM,GAAG,GAAG;YAC/C,OAAO,CAAC,qCAAqC,EAAE,QAAQ,MAAM,CAAC,EAAE,EAAE;QACpE;QACA,oDAAoD;QACpD,OAAO;IACT;IAEA,IAAI,OAAO,qBAAO,6LAAC;QAAI,WAAU;kBAAiB;;;;;;IAClD,IAAI,CAAC,OAAO,MAAM,EAAE,qBAAO,6LAAC;QAAI,WAAU;kBAAkB;;;;;;IAE5D,qBACE,6LAAC;QAAI,WAAU;;0BACb,6LAAC;gBAAI,WAAU;0BACb,cAAA,6LAAC;8BAAG;;;;;;;;;;;0BAEN,6LAAC;gBAAI,WAAU;0BACb,cAAA,6LAAC;;sCACC,6LAAC;sCACC,cAAA,6LAAC;;kDACC,6LAAC;kDAAG;;;;;;kDACJ,6LAAC;kDAAG;;;;;;kDACJ,6LAAC;kDAAG;;;;;;kDACJ,6LAAC;kDAAG;;;;;;kDACJ,6LAAC;kDAAG;;;;;;;;;;;;;;;;;sCAGR,6LAAC;sCACE,OAAO,GAAG,CAAC,CAAC,OAAO,sBAClB,6LAAC;oCAAmB,SAAS,CAAC,IAAM,iBAAiB,OAAO;;sDAC1D,6LAAC;sDAAI,QAAQ;;;;;;sDACb,6LAAC;sDAAI,MAAM,IAAI,CAAC,QAAQ;;;;;;sDACxB,6LAAC;sDAAI,MAAM,OAAO,IAAI;;;;;;sDACtB,6LAAC;sDAAI,WAAW,MAAM,SAAS;;;;;;sDAC/B,6LAAC;sDACC,cAAA,6LAAC;gDACC,OAAO,oBAAoB,MAAM,MAAM;gDACvC,UAAU,CAAC,IACT,mBAAmB,MAAM,GAAG,EAAE,MAAM,IAAI,CAAC,GAAG,EAAE,EAAE,MAAM,CAAC,KAAK,EAAE,MAAM,MAAM;gDAE5E,WAAW,CAAC,cAAc,EAAE,MAAM,MAAM,EAAE;gDAC1C,SAAS,CAAC,IAAM,EAAE,eAAe;gDACjC,UAAU,MAAM,MAAM,KAAK;;kEAE3B,6LAAC;wDAAO,OAAM;kEAAY;;;;;;kEAC1B,6LAAC;wDAAO,OAAM;kEAAiB;;;;;;kEAC/B,6LAAC;wDAAO,OAAM;kEAAe;;;;;;kEAC7B,6LAAC;wDAAO,OAAM;kEAAS;;;;;;;;;;;;;;;;;;mCAlBpB,MAAM,GAAG;;;;;;;;;;;;;;;;;;;;;YA2BzB,aAAa,+BACZ,6LAAC;gBAAI,WAAU;gBAAgB,SAAS;0BACtC,cAAA,6LAAC;oBAAI,WAAU;oBAAe,SAAS,CAAC,IAAM,EAAE,eAAe;;sCAC7D,6LAAC;4BAAO,WAAU;4BAAe,SAAS;sCAAY;;;;;;sCACtD,6LAAC;sCAAG;;;;;;sCACJ,6LAAC;;8CACC,6LAAC;8CAAO;;;;;;gCAAoB;gCAAE,cAAc,IAAI,CAAC,QAAQ;;;;;;;sCAE3D,6LAAC;;8CACC,6LAAC;8CAAO;;;;;;gCAAiB;gCAAE,cAAc,OAAO,IAAI;;;;;;;sCAEtD,6LAAC;;8CACC,6LAAC;8CAAO;;;;;;gCAAc;gCAAE,WAAW,cAAc,SAAS;;;;;;;sCAE5D,6LAAC;;8CACC,6LAAC;8CAAO;;;;;;gCAAoB;gCAAE,oBAAoB,cAAc,MAAM;;;;;;;sCAExE,6LAAC;sCAAG;;;;;;sCACJ,6LAAC;sCACE,cAAc,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,oBAC9B,6LAAC;;sDACC,6LAAC;4CACC,KAAK,gBAAgB,KAAK,OAAO;4CACjC,KAAK,KAAK,OAAO,CAAC,IAAI;4CACtB,WAAU;4CACV,SAAS,CAAC;gDACR,oCAAoC;gDACnC,EAAE,MAAM,CAAsB,GAAG,GAAG;4CACvC;;;;;;sDAEF,6LAAC;4CAAI,WAAU;;8DACb,6LAAC;oDAAI,WAAU;8DAAgB,KAAK,OAAO,CAAC,IAAI;;;;;;8DAChD,6LAAC;oDAAI,WAAU;;wDACZ,KAAK,QAAQ;wDAAC;wDAAI,CAAC,KAAK,OAAO,CAAC,aAAa,IAAI,KAAK,OAAO,CAAC,KAAK,EAAE,cAAc;wDAAG;wDAAQ;wDAC9F,sBAAsB,KAAK,OAAO,EAAE,KAAK,QAAQ,EAAE,cAAc;wDAAG;;;;;;;;;;;;;;mCAdlE;;;;;;;;;;sCAoBb,6LAAC;4BAAI,WAAU;;gCAAQ;gCACA,oBAAoB,cAAc,KAAK,EAAE,cAAc;gCAAG;;;;;;;;;;;;;;;;;;;;;;;;AAO7F;GArOwB;KAAA","debugId":null}}]
}